#!/usr/bin/tclsh

package require Itcl

package require tcltest
namespace import tcltest::*

package require WebDriver
package require Error
package require OOSupport
namespace import OOSupport::*

package require uri

set DATA_DIR "[file dirname [file normalize $::argv0]]/data"
set URL1 "file://$DATA_DIR/html/page1.html"
set URL2 "file://$DATA_DIR/html/page2.html"
set URL3 "file://$DATA_DIR/html/page3.html"

#
# TEST CASES
#

test ut_webdriver_session {
    Connect to Selenium Server, open session, do some random stuff, delete session.
} {
    -result 0
    -setup {
        set cap [::itcl::code [WebDriver::Capabilities #auto]]
        $cap set_browser_name "htmlunit"
    }
    -body {

        except {
            set session [WebDriver::Session #auto http://127.0.0.1:4444/wd/hub $cap]
            set window  [$session active_window]

            $window set_url $URL1
            $window set_url $URL2
            $window set_url $URL3

            $window back

            set current_url [$window url]
            if {[uri::canonicalize $current_url] != [uri::canonicalize $URL2]} {
                error "expected to be at $URL2, but URL is $current_url"
            }

            $window forward
            set current_url [$window url]
            if {[uri::canonicalize $current_url] != [uri::canonicalize $URL3]} {
                error "expected to be at $URL3, but URL is $current_url"
            }

            $window refresh
            ::itcl::delete object $session
        } e {
            ::Exception {
                error "caught exception: [$e msg]"
            }
        }

        return 0
    }
}

