#!/usr/bin/tclsh

package require Itcl

package require tcltest
namespace import tcltest::*

package require OOSupport
namespace import OOSupport::*

#
# PREAMBLE
#

::itcl::class SomeObject {

    common attributes {
        {string name "" rw}
    }

    method constructor {name} {
        init_attributes
        $this set_name $name
    }

    bless_attributes -json_support -collapse_underscore
}

::itcl::class LotsOfArrays {

    common attributes {
        {[bool]          array_of_bools {true false false true} rw}
        {[number]        array_of_nums  {1.0 2.0 3.0 4.0 5.0}   rw}
        {[::SomeObject]  array_of_objs  {}                      rw}
        {[string]        array_of_strs  {a abc aaze aaks aa s}  rw}
    }

    method constructor {} {
        init_attributes
    }

    bless_attributes -json_support -collapse_underscore
}

set OBJ_OF_ARRAYS_JSON \
{{
	"arrayOfBools":
	[
		true, false, false, true
	],
	"arrayOfNums":
	[
		1.0, 2.0, 3.0, 4.0, 5.0
	],
	"arrayOfObjs":
	[
			{
				"name": "object 1"
			},
			{
				"name": "object 2"
			}
	],
	"arrayOfStrs":
	[
		"a", "abc", "aaze", "aaks", "aa", "s"
	]
}}

#
# TEST CASES
#

test ut_oosupport_arrays_to_json {
    Test JSON serialization of an object containing different types of arrays
} {
    -result 0
    -setup {
        set obj1 [::itcl::code [SomeObject #auto "object 1"]]
        set obj2 [::itcl::code [SomeObject #auto "object 2"]]

        set loas [LotsOfArrays #auto]
        $loas set_array_of_objs [list $obj1 $obj2]
    }
    -body {
        if {[$loas to_json] != $OBJ_OF_ARRAYS_JSON} {
            error "error in JSON"
        }

        return 0
    }
}

